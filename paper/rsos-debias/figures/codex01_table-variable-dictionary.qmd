---
title: "Untitled"
format: html
editor: visual
---

```{r}
library(dplyr)
library(stringr)
library(gt)
library(webshot2)

# --- original rows ----------------------------------------------------------
raw_tbl <- tribble(
  ~Dimension,           ~Variable,
  "Demographic",    "Residents",
  "",               "Households",
  "",               "UK (%)",
  "",               "Female (%)",
  "",               "Age bands (%): 0-4, 5-9, 10-14, ..., 85-89",
  "Socioeconomic",  "Not deprived (% households)",
  "",               "Non-white (%)",
  "",               "Bad health (%)",
  "",               "Severe disability (%)",
  "",               "Socioeconomic classification [SEC] (%): higher managerial, lower managerial, intermediate, small employers, lower supervisory, semi-routine, routine, no work, students",
  "",               "Qualifications (%): no qualifications, level 4 qualifications",
  "Housing",       "No car (% households)",
  "",               "No central heating (% households)",
  "",               "Owned (% households)",
  "Location",      "Longitude",
  "",               "Latitude"
)

# --- clean Variable + add Description ---------------------------------------
tbl <- raw_tbl %>%
  mutate(
    variable_clean = Variable %>%
      str_replace_all("\\s*\\[[^\\]]*\\]", "") %>%  # remove [ ... ]
      str_replace_all("\\s*\\([^\\)]*\\)", "") %>%  # remove ( ... )
      str_replace("\\s*:.*$", "") %>%               # drop text after :
      str_replace("\\s*%\\s*$", "") %>%             # drop trailing %
      str_squish(),
    Variable = if_else(Variable == "", "", variable_clean),
    Description = case_when(
      Variable == "" ~ "",
      Variable == "Residents" ~ "Number of resident population.",
      Variable == "Households" ~ "Number of households.",
      Variable == "UK" ~ "Percentage of people who were born in the United Kingdom.",
      Variable == "Female" ~ "Percentage of residents who are female.",
      Variable == "Age bands" ~ "Percentage of residents in each age band: 0-4, 5-9, 10-14, ..., 85-89.",
      Variable == "Not deprived" ~ "Percentage of households not experiencing deprivation.",
      Variable == "Non-white" ~ "Percentage of residents who are non‑white.",
      Variable == "Bad health" ~ "Percentage of residents reporting bad or very bad health.",
      Variable == "Severe disability" ~ "Percentage of residents with a severe disability.",
      Variable == "Socioeconomic classification" ~ "Percentage of residents by group based on the National Statistics Socio-economic Classification (NS-SEC).",
      Variable == "Qualifications" ~ "Percentage of residents by highest qualification level: no qualifications, level 4 qualifications.",
      Variable == "No car" ~ "Percentage of households with no car.",
      Variable == "No central heating" ~ "Percentage of households without central heating.",
      Variable == "Owned" ~ "Percentage of households that are owner‑occupied.",
      Variable == "Longitude" ~ "Longitude coordinate of area centroid.",
      Variable == "Latitude" ~ "Latitude coordinate of area centroid.",
      TRUE ~ ""
    )
  ) %>%
  select(Dimension, Variable, Description)

# --- render table -----------------------------------------------------------
tbl_vars <- tbl %>%
  gt() %>%
  opt_table_font(list(google_font("Roboto Condensed"))) %>%
  cols_align("left", columns = everything()) %>%
  cols_width(Dimension ~ px(130), Variable ~ px(160), Description ~ px(450)) %>%
  # tab_options needs color/style/width separately
  tab_options(
    table.border.top.color = "black",
    table.border.top.style = "solid",
    table.border.top.width = px(3),
    table.border.bottom.color = "black",
    table.border.bottom.style = "solid",
    table.border.bottom.width = px(3),
    column_labels.border.bottom.color = "black",
    column_labels.border.bottom.style = "solid",
    column_labels.border.bottom.width = px(3),
    data_row.padding = px(6)
  ) %>%
  # <-- Add this anywhere after gt(); here is a good place
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  # keep your other styles
  # tab_style(
  #   style = cell_text(weight = "bold"),
  #   locations = cells_body(rows = 1)
  # ) %>%
    tab_style(
    style = cell_text(v_align = "top"),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_borders(sides = "top", color = "black", style = "solid", weight = px(3)),
    locations = cells_body(rows = Dimension != "")
  )

print(tbl_vars)

tbl_vars <- tbl_vars %>%
  text_transform(
    locations = cells_body(columns = Description),
    fn = function(x) str_replace_all(str_wrap(x, width = 80), "\n", "<br>")
  ) %>%
  fmt_markdown(columns = Description)

gtsave(tbl_vars, "/Users/franciscorowe/Library/CloudStorage/Dropbox/Francisco/Research/grants/2023/digital-footprint-accelerator/debias/github/bias-detection/paper/rsos-debias/figures/01_table-variable-dictionary.pdf",   vwidth  = 1400,   # wider canvas
  vheight = 3200,    # tall enough to fit the whole table
  zoom    = 1
  )
```